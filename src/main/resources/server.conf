###############################################################################
#                                                                             # 
#    Copyright 2016, AdeptJ (http://www.adeptj.com)                           #
#                                                                             #
#    Licensed under the Apache License, Version 2.0 (the "License");          #
#    you may not use this file except in compliance with the License.         #
#    You may obtain a copy of the License at                                  #
#                                                                             #
#        http://www.apache.org/licenses/LICENSE-2.0                           #
#                                                                             #
#    Unless required by applicable law or agreed to in writing, software      #
#    distributed under the License is distributed on an "AS IS" BASIS,        #
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. #
#    See the License for the specific language governing permissions and      #
#    limitations under the License.                                           #
#                                                                             #
###############################################################################

main: {

  # Undertow Configurations.

  undertow: {

    common: {

      default-encoding: UTF-8

      max-concurrent-requests: 5000

      req-limit-queue-size: 100000

      req-buffering-maxBuffers: 200

      server-allowed-methods: [OPTIONS, GET, HEAD, PUT, POST, DELETE, PATCH]

      header-server: AdeptJ Runtime

      ignore-flush: true

      session-cookie-httpOnly: true

      use-cached-auth-mechanism: true

      change-sessionId-on-login: true

      invalidate-session-on-logout: true

      # Session timeout in seconds.
      session-timeout: 3600

      auth-roles: [OSGiAdmin]

      protected-paths: ["/system/console/*", /server/logs, /logback-status]

      protected-paths-secured-for-methods: [OPTIONS, GET, HEAD, PUT, POST, DELETE, PATCH, TRACE, CONNECT]

      # Principal vs Credential mapping.
      user-credential-mapping: {
        admin: "{sha-256}jGl25bVBBBW96Qi9Te4V37Fnqchz/Eu4qB9vKrRIqRg="
      }

      # Principal vs Roles mapping : Map<String, List<String>>
      user-roles-mapping: {
        admin: [AdeptJRuntimeAdmin, OSGiAdmin]
      }

      context-path: /

      system-console-path: /system/console/bundles

      health-check-handler-path: /health

      admin-servlet-path: "/admin/*"

      error-handler-path: /ErrorHandler

      logback-status-servlet-path: /logback-status

      error-handler-codes: [401, 403, 404, 500, 503]

      osgi-error-pages: [401, 403, 404, 500, java.lang.Exception]

      static-resource-prefix: /static

      static-resource-extns: [css, js, jpg, png, jpeg, eot, svg, ttf, woff, woff2, otf, less, scss, map, ico]

      resource-mgr-prefix: WEB-INF

      # Multipart default configurations

      # 100MB = 104857600 bytes | 200MB = 209715200 bytes | 20MB = 20971520 bytes | 2MB = 2097152 bytes

      # The directory location where files will be stored
      multipart-file-location: ${java.io.tmpdir}

      # The maximum size allowed for uploaded files
      multipart-max-file-size: 104857600

      # The maximum size allowed for multipart/form-data requests
      multipart-max-request-size: 209715200

      # The size threshold after which files will be written to disk
      multipart-file-size-threshold: 2097152

    }

    http: {
      host: 0.0.0.0
      port: 8080
    }

    https: {
      host: 0.0.0.0
      port: 8443
      enabled: true
      # Lets defaults to v1.3, Jvm args will always have priority.
      tlsVersion: TLSv1.3
      redirect-to-http: false
      keystore-type: PKCS12
      p12-file-location: /server.p12
      p12-password: "changeit"
    }

    # Worker Options
    worker-options: {

      WORKER_TASK_CORE_THREADS: 64

      # Just doubling the core threads.

      WORKER_TASK_MAX_THREADS: 128

      TCP_NODELAY: true

      CORK: true

      # The high water mark for a server's connections.  Once this number of connections have been accepted,
      # accepts will be suspended for that server.

      # Value exactly defined by Undertow, provide just in case needs to be modified.

      CONNECTION_HIGH_WATER: 1000000

      # The low water mark for a server's connections.  Once the number of active connections have dropped
      # below this number, accepts can be resumed for that server.

      # Value exactly defined by Undertow, provide just in case needs to be modified.

      CONNECTION_LOW_WATER: 1000000

    }

    # Socket Options
    socket-options: {

      # Configure a TCP socket to disable Nagle's algorithm.

      TCP_NODELAY: true

      # Configure a channel to send TCP keep-alive messages in an implementation-dependent manner.

      KEEP_ALIVE: true

      # Configure an IP socket to reuse addresses

      REUSE_ADDRESSES: true

      # The high water mark for a server's connections.  Once this number of connections have been accepted,
      # accepts will be suspended for that server.

      CONNECTION_HIGH_WATER: 20000

      # The low water mark for a server's connections.  Once the number of active connections have dropped
      # below this number, accepts can be resumed for that server.

      CONNECTION_LOW_WATER: 20000

    }

    # Server | Connection Options
    # see http://undertow.io/undertow-docs/undertow-docs-1.3.0/index.html#common-listener-options
    server-options: {

      options-type-long: {

        # The default maximum size of a request entity.
        # Defaults to unlimited.

        MAX_ENTITY_SIZE: -1

        # The default maximum size of the HTTP entity body when using the multipart parser.
        # Generally this will be larger than MAX_ENTITY_SIZE
        # If this is not specified it will be the same as MAX_ENTITY_SIZE

        MULTIPART_MAX_ENTITY_SIZE: -1

      }

      options-type-others: {

        # The maximum size of a HTTP header block, in bytes.
        # If a client sends more data that this as part of the request header then the connection will be closed 100K.

        MAX_HEADER_SIZE: 102400

        # The idle timeout in milliseconds after which the channel will be closed.
        # If the underlying channel already has a read or write timeout set
        # the smaller of the two values will be used for read/write timeouts.
        # Defaults to unlimited (-1).

        IDLE_TIMEOUT: 10000

        #The size of the SSL server session cache

        SSL_SERVER_SESSION_CACHE_SIZE: 20480

        #The SSL server session timeout (in seconds).

        SSL_SERVER_SESSION_TIMEOUT: 6000

        # The maximum allowed time of reading HTTP request in milliseconds.
        # -1 or missing value disables this functionality.

        REQUEST_PARSE_TIMEOUT: 60000

        # The amount of time the connection can be idle with no current requests
        # before it is closed;
        # Defaults to unlimited (-1).

        # Configuring exactly specified by Undertow server options.

        NO_REQUEST_TIMEOUT: 60000

        # The maximum number of query parameters that are permitted in a request.
        # If a client sends more than this number the connection will be closed.
        # This limit is necessary to protect against hash based denial of service attacks.
        # Defaults to 1000.

        MAX_PARAMETERS: 1000

        # The maximum number of headers that are permitted in a request.
        # If a client sends more than this number the connection will be closed.
        # This limit is necessary to protect against hash based denial of service attacks.
        # Defaults to 200.

        MAX_HEADERS: 200

        # The maximum number of cookies that are permitted in a request.
        # If a client sends more than this number the connection will be closed.
        # This limit is necessary to protect against hash based denial of service attacks.
        # Defaults to 200.

        MAX_COOKIES: 200

        # If this is true then a Connection: keep-alive header will be added to responses,
        # even when it is not strictly required by the specification.
        # If you are writing some kind of super high performance application and are worried about the extra data being sent
        # over the wire this option allows you to turn it off
        # Defaults to true

        ALWAYS_SET_KEEP_ALIVE: true

        # If the server should record the start time of a HTTP request. This is necessary if you
        # wish to log or otherwise use the total request time, however has a slight performance
        # impact, as it means that System.nanoTime() must be called for each request

        RECORD_REQUEST_START_TIME: false

        ENABLE_STATISTICS: false

        # If this is true then a Date header will be added to all responses.
        # The HTTP spec says this header should be added to all responses,
        # unless the server does not have an accurate clock.
        # Defaults to true

        ALWAYS_SET_DATE: true

        # Enable HTTP2
        ENABLE_HTTP2: true

        # The charset to use to decode the URL and query parameters.
        # Defaults to UTF-8.
        URL_CHARSET: UTF-8

      }
    }

  }

  # Common configurations.

  common: {
    startup-info-file: /banner.txt
    browsers: [chromium-browser, firefox, mozilla, konqueror, netscape, opera, links, lynx]
    # Hashing security settings: Recommended Values
    salt-size: 16
    secure-random-algo: SHA1PRNG
    derived-key-size: 128
    secret-key-algo: PBKDF2WithHmacSHA256
    iteration-count: 10000
    deployment-dir: ${user.dir}${file.separator}adeptj-runtime${file.separator}deployment
    osgi-dir: ${main.common.deployment-dir}${file.separator}osgi
    logs-dir: ${main.common.deployment-dir}${file.separator}logs
  }


  # Apache Felix and OSGi configurations.

  felix: {
    bundles-root-dir: bundles/
    felix-cm-dir: ${main.common.osgi-dir}${file.separator}configs
    memoryusage-dump-loc: ${main.common.osgi-dir}${file.separator}heapdumps
    felix-log-level-default-value: 3
  }

  # Logging configurations.

  logging: {
    console-appender-name: CONSOLE
    file-appender-name: ROLLING_FILE
    async-appender-name: ASYNC
    log-pattern-file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger - %msg%n"
    log-pattern-console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %green([%thread]) %highlight_ext(%-5level) %cyan(%logger) - %msg%n"
    log-max-history: 30
    log-max-size: 10MB
    server-log-file: ${main.common.logs-dir}${file.separator}server.log
    rollover-server-log-file: ${main.common.logs-dir}${file.separator}"error-%d{yyyy-MM-dd}.%i.gz"
    root-log-level: INFO
    async-log-queue-size: 1000
    async-log-discardingThreshold: 0
    file-appender-immediate-flush: false

    # Plan is to declare loggers as a List of Map where each entry is Map containing the logging configs.

    loggers: [

      {
        name: com.adeptj
        level: INFO
        additivity: false
      }

      {
        name: org.xnio
        level: INFO
        additivity: false
      }

      {
        name: io.undertow
        level: INFO
        additivity: false
      }

      {
        name: org.trimou
        level: INFO
        additivity: false
      }

      {
        name: org.hibernate
        level: INFO
        additivity: false
      }

      {
        name: org.jboss.resteasy
        level: INFO
        additivity: false
      }

      {
        name: org.jboss.logging
        level: INFO
        additivity: false
      }

      {
        name: eclipselink.logging
        level: DEBUG
        additivity: false
      }

      {
        name: com.zaxxer
        level: INFO
        additivity: false
      }

      {
        name: org.eclipse.yasson
        level: INFO
        additivity: false
      }

    ]

  }

  # Trimou configurations.

  trimou: {
    template-locator-priority: 1
    prefix: WEB-INF/templates/
    suffix: html
    cache-enabled: true
    # Template cache expiration in seconds
    cache-expiration: 3600
    start-delimiter: "{{"
    end-delimiter: "}}"
    resource-bundle-basename: WEB-INF/i18n/messages
  }

  resteasy: {
    servlet-mapping-prefix: /
    role-based-security: true
    allow-gzip: true
  }
}